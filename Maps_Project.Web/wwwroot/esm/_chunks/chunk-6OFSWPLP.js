import{c as p,g as v,h as g,k as d}from"./chunk-LRH74UCM.js";var i=v(d(),1);var m=class extends i.DataGrid{constructor(e,t){super(e,t);this._rolePermissions={};this._implicitPermissions={};let s={};this.getSortedGroupAndPermissionKeys(s,r=>{if(!this.element)return;let o=r.map(a=>({Key:a,ParentKey:this.getParentKey(a),Title:s[a],GrantRevoke:null,IsGroup:a.charAt(a.length-1)===":"}));this.byParentKey=(0,i.toGrouping)(o,a=>a.ParentKey),this.setItems(o),this.value=this._value})}getIdProperty(){return"Key"}getItemGrantRevokeClass(e,t){if(!e.IsGroup)return e.GrantRevoke===t?" checked":"";let s=this.getDescendants(e,!0),r=s.filter(o=>o.GrantRevoke===t);return r.length?s.length===r.length?"checked":"checked partial":""}roleOrImplicit(e){if(this._rolePermissions[e])return!0;for(var t of Object.keys(this._rolePermissions)){var s=this._implicitPermissions[t];if(s&&s[e])return!0}for(var r of Object.keys(this._implicitPermissions)){var o=this.view.getItemById(r);if(o&&o.GrantRevoke==!0){var s=this._implicitPermissions[r];if(s&&s[e])return!0}}}getItemEffectiveClass(e){if(e.IsGroup){let s=this.getDescendants(e,!0),r=(0,i.count)(s,o=>o.GrantRevoke===!0||o.GrantRevoke==null&&this.roleOrImplicit(o.Key));return r===s.length||s.length===0?"allow":r===0?"deny":"partial"}return e.GrantRevoke===!0||e.GrantRevoke==null&&this.roleOrImplicit(e.Key)?" allow":" deny"}getColumns(){let e=[{name:(0,i.localText)("Site.UserPermissionDialog.Permission"),field:"Title",format:i.SlickFormatting.treeToggle(()=>this.view,t=>t.Key,t=>{let s=t.item;return'<span class="effective-permission '+this.getItemEffectiveClass(s)+'">'+(0,i.htmlEncode)(t.value)+"</span>"}),width:495,sortable:!1},{name:(0,i.localText)("Site.UserPermissionDialog.Grant"),field:"Grant",format:t=>{let s=t.item;return"<span class='check-box grant no-float "+this.getItemGrantRevokeClass(s,!0)+"'></span>"},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}];return this.options.showRevoke&&e.push({name:(0,i.localText)("Site.UserPermissionDialog.Revoke"),field:"Revoke",format:t=>{let s=t.item;return'<span class="check-box revoke no-float '+this.getItemGrantRevokeClass(s,!1)+'"></span>'},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}),e}setItems(e){i.SlickTreeHelper.setIndents(e,t=>t.Key,t=>t.ParentKey,!1),this.view.setItems(e,!0)}onViewSubmit(){return!1}onViewFilter(e){return!super.onViewFilter(e)||!i.SlickTreeHelper.filterById(e,this.view,t=>t.ParentKey)?!1:this.searchText?this.matchContains(e)||e.IsGroup&&(0,i.any)(this.getDescendants(e,!1),t=>this.matchContains(t)):!0}matchContains(e){return Select2.util.stripDiacritics(e.Title||"").toLowerCase().indexOf(this.searchText)>=0}getDescendants(e,t){let s=[],r=[e];for(;r.length>0;){let o=r.pop(),a=this.byParentKey[o.Key];if(a)for(let n of a)(!t||!n.IsGroup)&&s.push(n),r.push(n)}return s}onClick(e,t,s){if(super.onClick(e,t,s),e.isDefaultPrevented()||i.SlickTreeHelper.toggleClick(e,t,s,this.view,n=>n.Key),e.isDefaultPrevented())return;let r=$(e.target),o=r.hasClass("grant");if(o||r.hasClass("revoke")){e.preventDefault();let n=this.itemAt(t),l=r.hasClass("checked")||r.hasClass("partial");if(l?o=null:o=o!==l,n.IsGroup)for(var a of this.getDescendants(n,!0))a.GrantRevoke=o;else n.GrantRevoke=o;this.slickGrid.invalidate()}}getParentKey(e){e.charAt(e.length-1)===":"&&(e=e.substr(0,e.length-1));let t=e.lastIndexOf(":");return t>=0?e.substr(0,t+1):null}getButtons(){return[]}createToolbarExtensions(){super.createToolbarExtensions(),i.GridUtils.addQuickSearchInputCustom(this.toolbar.element,(e,t)=>{this.searchText=Select2.util.stripDiacritics((0,i.trimToNull)(t)||"").toLowerCase(),this.view.setItems(this.view.getItems(),!0)})}getSortedGroupAndPermissionKeys(e,t){(0,i.getRemoteDataAsync)("Administration.PermissionKeys").then(s=>{var a;let r={};for(var o of s){let n=o;if(!n||n.charAt(n.length-1)==":"&&(n=n.substring(0,n.length-1),n.length===0)||e[n])continue;e[n]=(a=(0,i.tryGetText)("Permission."+n))!=null?a:n;let l=n.split(":"),h="",c="";for(let u=0;u<l.length-1;u++){h=h+l[u]+":";let f=(0,i.tryGetText)("Permission."+h);f==null&&(f=l[u]),e[h]=f,c=c+e[h]+":",r[h]=c}r[n]=c+e[n]}s=Object.keys(e),s=s.sort((n,l)=>(0,i.turkishLocaleCompare)(r[n],r[l])),t(s)})}get value(){let e=[];if(!this.view.getItems().length)return(this._value||[]).map(t=>({PermissionKey:t.PermissionKey,Granted:t.Granted}));for(let t of this.view.getItems())t.GrantRevoke!=null&&t.Key.charAt(t.Key.length-1)!=":"&&e.push({PermissionKey:t.Key,Granted:t.GrantRevoke});return e}set value(e){var t;this._value=e;for(let s of this.view.getItems())s.GrantRevoke=null;if(e!=null)for(let s of e){let r=this.view.getItemById(s.PermissionKey);r&&(r.GrantRevoke=(t=s.Granted)!=null?t:!0)}this.setItems(this.getItems())}get rolePermissions(){return Object.keys(this._rolePermissions)}set rolePermissions(e){if(this._rolePermissions={},e)for(let t of e)this._rolePermissions[t]=!0;this.setItems(this.getItems())}set implicitPermissions(e){if(this._implicitPermissions={},e)for(var t of Object.keys(e)){this._implicitPermissions[t]=this._implicitPermissions[t]||{};var s=e[t];if(s)for(var r of s)this._implicitPermissions[t][r]=!0}}};p(m,"PermissionCheckEditor"),m=g([i.Decorators.registerEditor("Maps_Project.Administration.PermissionCheckEditor",[i.IGetEditValue,i.ISetEditValue])],m);export{m as a};
//# sourceMappingURL=chunk-6OFSWPLP.js.map
